name: Local CI/CD for Laravel Docker

on:
  push:
    branches: ["dev"]
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ§¹ Clean up old containers and images
      run: |
        echo "Stopping existing containers..."
        docker-compose down || true
        echo "Removing unused images..."
        docker image prune -f

    - name: ğŸ—ï¸ Build and start Docker containers
      run: |
        echo "Building containers..."
        docker-compose up -d --build
        echo "Containers started successfully!"

    - name: â³ Wait for MySQL to be ready
      run: |
        echo "Waiting for MySQL to be ready..."
        timeout=60
        counter=0
        until docker-compose exec -T mysql mysqladmin ping -h localhost -u root -proot --silent; do
          counter=$((counter+1))
          if [ $counter -gt $timeout ]; then
            echo "âŒ MySQL failed to start within ${timeout} seconds"
            docker-compose logs mysql
            exit 1
          fi
          echo "Waiting... ($counter/$timeout)"
          sleep 2
        done
        echo "âœ… MySQL is ready!"

    - name: ğŸ“¦ Install Composer dependencies
      run: |
        echo "Installing composer dependencies..."
        docker-compose exec -T app composer install --no-interaction --prefer-dist --optimize-autoloader

    - name: ğŸ“„ Setup environment file
      run: |
        if ! docker-compose exec -T app test -f .env; then
          echo "Creating .env file from .env.example..."
          docker-compose exec -T app cp .env.example .env
        else
          echo ".env file already exists"
        fi

    - name: ğŸ”‘ Generate application key
      run: |
        echo "Generating application key..."
        docker-compose exec -T app php artisan key:generate --force || echo "âš ï¸ Key already exists"

    - name: ğŸ—„ï¸ Run database migrations
      run: |
        echo "Running database migrations..."
        docker-compose exec -T app php artisan migrate --force
        echo "âœ… Migrations completed!"

    - name: ğŸŒ± Seed database (optional)
      run: |
        echo "Seeding database..."
        docker-compose exec -T app php artisan db:seed --force || echo "âš ï¸ No seeders or seeding failed"
      continue-on-error: true

    - name: ğŸ§ª Run tests
      run: |
        echo "Running tests..."
        docker-compose exec -T app php artisan test --parallel
      continue-on-error: true

    - name: ğŸ§¹ Clear and cache configuration
      run: |
        echo "Clearing cache..."
        docker-compose exec -T app php artisan optimize:clear
        echo "Caching configuration..."
        docker-compose exec -T app php artisan config:cache
        docker-compose exec -T app php artisan route:cache
        docker-compose exec -T app php artisan view:cache
        echo "âœ… Cache optimized!"

    - name: ğŸ“ Set proper permissions
      run: |
        echo "Setting permissions..."
        docker-compose exec -T app chmod -R 775 storage bootstrap/cache
        docker-compose exec -T app chown -R www-data:www-data storage bootstrap/cache || true
        echo "âœ… Permissions set!"

    - name: ğŸ”„ Restart containers
      run: |
        echo "Restarting containers..."
        docker-compose restart app nginx
        echo "âœ… Containers restarted!"

    - name: ğŸ“Š Show container status
      run: |
        echo "=== Container Status ==="
        docker-compose ps
        echo ""
        echo "=== Application Logs (last 20 lines) ==="
        docker-compose logs --tail=20 app

    - name: âœ… Deployment Summary
      if: success()
      run: |
        echo "========================================"
        echo "âœ… DEPLOYMENT SUCCESSFUL!"
        echo "========================================"
        echo "ğŸŒ Application URL: http://localhost:8000"
        echo "ğŸ—„ï¸ phpMyAdmin URL: http://localhost:8081"
        echo "ğŸ“Š MySQL Port: 3308"
        echo "========================================"

    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "========================================"
        echo "âŒ DEPLOYMENT FAILED!"
        echo "========================================"
        echo "ğŸ“‹ Showing recent logs..."
        docker-compose logs --tail=50
        echo "========================================"

    - name: ğŸ§¹ Cleanup on failure
      if: failure()
      run: |
        echo "Cleaning up failed deployment..."
        docker-compose down || true