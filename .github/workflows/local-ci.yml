name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check if rebuild needed
      id: check
      run: |
        $files = git diff --name-only HEAD~1 HEAD
        if ($files -match "Dockerfile|composer.json|composer.lock") {
          echo "rebuild=true" >> $env:GITHUB_OUTPUT
        } else {
          echo "rebuild=false" >> $env:GITHUB_OUTPUT
        }
      shell: powershell
    
    - name: Deploy
      run: |
        docker-compose down
        if ("${{ steps.check.outputs.rebuild }}" -eq "true") {
          Write-Host "ðŸ”¨ Rebuilding image..."
          docker-compose up -d --build
        } else {
          Write-Host "âš¡ Fast deploy (no rebuild)..."
          docker-compose up -d --no-build
        }
        Start-Sleep -Seconds 10
        docker-compose exec -T app php artisan optimize:clear
      shell: powershell
    
    - name: Done
      run: echo "âœ… Deployed at http://localhost:8000"