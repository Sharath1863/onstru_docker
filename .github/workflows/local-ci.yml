name: Laravel CI/CD - Main Branch

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure containers are running
        run: |
          $running = docker ps --filter "name=laravel_app" --format "{{.Names}}"
          if ($running -eq "laravel_app") {
            Write-Host "Containers running, restarting..."
            docker compose restart app nginx
          } else {
            Write-Host "Containers not running, starting..."
            docker compose up -d
          }
        shell: powershell

      - name: Wait for containers
        run: Start-Sleep -Seconds 10
        shell: powershell

      - name: Check and install dependencies
        run: |
          $vendorExists = docker compose exec -T app test -d vendor
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Installing composer dependencies..."
            docker compose exec -T app composer install --no-interaction --prefer-dist
          } else {
            Write-Host "Vendor folder exists, skipping composer install"
          }
        shell: powershell
        timeout-minutes: 10

      - name: Run migrations
        run: docker compose exec -T app php artisan migrate --force
        shell: powershell

      - name: Clear cache
        run: docker compose exec -T app php artisan optimize:clear
        shell: powershell

      - name: Done
        run: Write-Host "âœ… Deployed! http://localhost:8000" -ForegroundColor Green
        shell: powershell