# .github/workflows/deploy.yml
name: Deploy
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy My Laravel App
        shell: powershell
        run: |
          # 1. Get latest code
          git pull origin main

          # 2. Stop & remove old containers (silently)
          docker compose down --remove-orphans 2>$null

          # 3. Build image only if it doesn't exist
          docker image inspect onstru_docker-app:latest >$null 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Building Docker image (first time)..."
            docker compose build app
          } else {
            Write-Host "Image already exists â€“ skipping build"
          }

          # 4. Start everything fresh
          docker compose up -d

          # 5. Wait a moment
          Start-Sleep -Seconds 15

          # 6. Run Laravel commands
          docker compose exec -T app php artisan migrate --force
          docker compose exec -T app php artisan optimize:clear

          # Done!
          Write-Host "All done! Visit http://localhost:8000"