# .github/workflows/deploy.yml
name: Deploy
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Deploy
        shell: python
        run: |
          from subprocess import run
          from time import sleep

          print("Deploying Laravel...")

          run("git pull origin main")
          run("docker compose down --remove-orphans")

          # Build only if image is missing
          if "missing" in run(
              "docker image inspect onstru_docker-app:latest >nul 2>&1 || echo missing",
              shell=True, capture_output=True, text=True
          ).stdout:
              run("docker compose build --no-cache app")

          run("docker compose up -d")
          sleep(15)

          run("docker compose exec -T app php artisan migrate --force")
          run("docker compose exec -T app php artisan optimize:clear")

          print("Done! Site â†’ http://localhost:8000")