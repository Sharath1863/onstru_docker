name: Laravel CI/CD (dev)

on:
  push:
    branches: [ main]

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: powershell   # everything in PowerShell, no mixing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # One single command = rebuild + restart only the app (zero downtime)
      - name: Deploy new code (fastest possible way)
        run: docker compose up -d --build --force-recreate --no-deps app nginx

      # Safe & instant MySQL wait (fails only if DB really dead)
      - name: Wait for MySQL
        run: |
          $attempts = 0
          while ($attempts -lt 20) {
            if (docker compose exec -T mysql mysqladmin ping -h127.0.0.1 --silent) {
              Write-Host "MySQL ready"
              break
            }
            Start-Sleep -Seconds 2
            $attempts++
          }

      # Run migrations (fail the deploy if they break — you want to know!)
      - name: Run migrations
        run: docker compose exec -T app php artisan migrate --force

      # The only cache command you really need for dev
      - name: Clear + optimize
        run: docker compose exec -T app php artisan optimize:clear

      # Done – pretty output
      - name: Deployment complete
        run: |
          Write-Host "==================================" -ForegroundColor Cyan
          Write-Host "Deployment to DEV successful!" -ForegroundColor Green
          Write-Host "URL: http://localhost:8000" -ForegroundColor Yellow
          Write-Host "Time: $(Get-Date -Format 'HH:mm:ss')" -ForegroundColor Cyan
          Write-Host "==================================" -ForegroundColor Cyan