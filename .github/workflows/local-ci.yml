# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instant Deploy (Windows + PowerShell)
        shell: powershell
        run: |
          # 1. Pull latest code
          git pull origin main

          # 2. Remove old containers (ignore errors if not exist)
          docker rm -f laravel_mysql laravel_app laravel_nginx laravel_phpmyadmin 2>$null

          # 3. Build image only if it doesn't exist yet
          $image = docker images -q onstru_docker-app:latest
          if (-not $image) {
            Write-Host "Image not found → building..."
            docker compose build --no-cache app
          } else {
            Write-Host "Image exists → skipping build (instant!)"
          }

          # 4. Start containers
          docker compose up -d

          # 5. Wait for MySQL & app to be ready
          Start-Sleep -Seconds 12

          # 6. Your exact commands
          docker compose exec -T app php artisan migrate --force
          docker compose exec -T app php artisan optimize:clear

      - name: Done
        shell: powershell
        run: |
          Write-Host "Deployed successfully!"
          Write-Host "Site: http://localhost:8000"
          Write-Host "phpMyAdmin: http://localhost:8081"