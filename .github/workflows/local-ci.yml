# .github/workflows/deploy.yml
name: Deploy → Production (100% automatic)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: powershell

    steps:
      - uses: actions/checkout@v4

      # SMART: Rebuild image ONLY when Dockerfile or composer files changed
      - name: Rebuild image if needed
        run: |
          if (git diff --quiet HEAD^ HEAD -- Dockerfile composer.json composer.lock docker-compose.yml) {
            Write-Host "No Docker/Composer changes → skipping rebuild" -ForegroundColor Cyan
          } else {
            Write-Host "Dockerfile or dependencies changed → rebuilding image" -ForegroundColor Yellow
            docker compose build --no-cache app
          }

      # Always apply latest containers + code (zero downtime)
      - name: Deploy instantly
        run: |
          docker compose up -d --force-recreate --no-deps app nginx
          docker compose exec -T app php artisan optimize:clear
          Write-Host "Deployed in 3–10 seconds → http://localhost:8000" -ForegroundColor Green